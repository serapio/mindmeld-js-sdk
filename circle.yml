## Customize the test machine
machine:

  timezone:
    America/Los_Angeles # Set the timezone

  # Install python for deploying to s3
  python:
    version:
      2.7.5

  # Install node for building tools
  node:
    version:
      0.10.28

  # Add some environment variables
  # Sensitive env variables go into the circle ui directly
  environment:
    CIRCLE_ENV: test

## Customize dependencies
dependencies:
  cache_directories:
    - "~/.package_cache" # Cache dependencies from npm, bower, and composer
    - phantomjs-2.0.0  # Store phantom tarball

  pre:
    - > # Dependencies for phantomjs
        sudo apt-get install g++ flex bison gperf ruby perl
        libsqlite3-dev libfontconfig1-dev libicu-dev libfreetype6 libssl-dev
        libpng-dev libjpeg-dev
    - npm install -g gulp@3.8.11 npm-cache@0.0.4
    - > # Download phantomjs v2.0.0 and build; this will become obsolete
        if [ ! -d phantomjs-2.0.0 ]; then
          wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.0.0-source.zip
          unzip phantomjs-2.0.0-source.zip
          ( cd phantomjs-2.0.0 && ./build.sh --confirm --jobs 1 )
        fi

  override:
    - npm-cache install

  post:
    # Python dependencies for deployment
    - pip install -r deployScripts/requirements.txt
    # Build the dist files and docs.
    - gulp

## Omit database setup, until we need it
database:
  override:
    - echo "No databases."

## Customize test commands
test:
  override:
    - gulp tests:
       environment: PATH=$HOME/phantomjs-2.0.0/bin/:$PATH

## Customize deployment commands
deployment:
  develop:
    branch: develop
    commands:
      - bash deployScripts/deploy_artifact.sh
  release:
    branch: /release\/.*/
    commands:
      - bash deployScripts/deploy_artifact.sh
  production:
    branch: master
    commands:
      - bash deployScripts/deploy_artifact.sh
      - gulp archive
      # The last part of the command is to get the current version.
      - bash deployScripts/deploy_archive.sh `node -e "console.log(require('./package.json').version)"`
  feature:
    branch: /feature\/.*/
    commands:
      #Build only if there's a CHEF_ENVIRONMENT variable set.
      - "[ -z \"$CHEF_ENVIRONMENT\" ] || bash deployScripts/deploy_artifact.sh"

## Custom notifications
#notify:
  #webhooks:
    ## A list of hashes representing hooks. Only the url field is supported.
    #- url: https://someurl.com/hooks/circle
